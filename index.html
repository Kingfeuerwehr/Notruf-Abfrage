<!DOCTYPE html>
<html lang="de" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notrufabfrage • AAO (Dark + Schwarzes Dropdown)</title>

  <!-- React + Babel + Tailwind -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>

  <style>
    /* globale Dark-Umgebung (Form-Controls etc.) */
    :root { color-scheme: dark; }

    /* Basis */
    body{ background:#000; color:#e5e7eb; }
    .card{ background:#0a0a0a; border:1px solid #1f2937; border-radius:1rem; }
    .btn{ border-radius:1rem; padding:.5rem .75rem; box-shadow:0 1px 2px rgba(0,0,0,.07); background:#111827; border:1px solid #334155; }
    .btn:hover{ background:#0f172a; }
    .badge{ display:inline-block; border-radius:9999px; padding:.125rem .5rem; font-size:.75rem; border:1px solid #334155 }
    .qty{ display:inline-flex; align-items:center; gap:.4rem; border:1px solid #334155; border-radius:9999px; padding:.2rem .55rem; background:transparent}
    .qty button{ width:1.6rem; height:1.6rem; border-radius:9999px; border:1px solid #334155; line-height:1.6rem; text-align:center }
    .invalid{ border-color:#ef4444 !important; box-shadow:0 0 0 1px rgba(239,68,68,.25) }
    textarea, input{ background:#0b0b0b; border-color:#334155; color:#e5e7eb }

    /* ====== Schwarzes Dropdown (Custom Select) ====== */
    .ds-wrap { position: relative; }
    .ds-btn  { width:100%; border:1px solid #334155; border-radius:.75rem; padding:.5rem .75rem; background:#0b0b0b; color:#e5e7eb; text-align:left; }
    .ds-btn.invalid{ box-shadow:0 0 0 1px rgba(239,68,68,.25); border-color:#ef4444; }
    .ds-caret{ position:absolute; right:.6rem; top:50%; transform:translateY(-50%); opacity:.7; pointer-events:none; }
    .ds-menu { position:absolute; left:0; right:0; top:calc(100% + .25rem); background:#0a0a0a; border:1px solid #334155; border-radius:.75rem; max-height:16rem; overflow:auto; z-index:60; box-shadow:0 10px 30px rgba(0,0,0,.45); }
    .ds-item { padding:.5rem .75rem; cursor:pointer; color:#e5e7eb; }
    .ds-item[aria-selected="true"] { background:#0f172a; }
    .ds-item:hover, .ds-item.ds-active { background:#111827; }
    .ds-help { font-size:.75rem; color:#fca5a5; margin-top:.25rem; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Logo (falls vorhanden) -->
  <div class="fixed top-3 right-3 z-40 pointer-events-none select-none">
    <!-- Passe den Pfad an oder entferne das img -->
    <!-- <img src="assets/ILS_Logo.png" alt="Logo" class="h-14 w-auto drop-shadow brightness-110" /> -->
  </div>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    /* =================== Daten: AAO & Stichworte =================== */
    const AAO = [
      // Brand
      { Stichwort: "B - 1", Fahrzeuge_AAO: "(H)LF oder TLF", Info: "Brand klein" },
      { Stichwort: "B - 2", Fahrzeuge_AAO: "ELW 1, 2x (H)LF, DLK, TLF & RTW", Info: "Brand mittel" },
      { Stichwort: "B - 3", Fahrzeuge_AAO: "ELW 1, 3x (H)LF, DLK, 2x TLF & RTW", Info: "Brand groß" },
      { Stichwort: "B - 4", Fahrzeuge_AAO: "ELW 2, 4x (H)LF, DLK, 3x TLF, 2x RTW", Info: "Brand sehr groß" },
      { Stichwort: "B - 2Y", Fahrzeuge_AAO: "ELW 1, 2x (H)LF, DLK, TLF & NEF, 2x RTW", Info: "Brand mittel, P in Gefahr" },
      { Stichwort: "B - 3Y", Fahrzeuge_AAO: "ELW 1, 3x (H)LF, DLK, 2x TLF & NEF, 3x RTW", Info: "Brand groß, 2 P in Gefahr" },
      { Stichwort: "B - 4Y", Fahrzeuge_AAO: "ELW 2, 4x (H)LF, DLK, 3x TLF & 2x NEF, 4x RTW", Info: "Brand sehr groß, 3+ P" },

      // BMA/CO/RWM
      { Stichwort: "BMA", Fahrzeuge_AAO: "ELW 1, (H)LF, DLK (bei Bedarf)", Info: "Brandmeldeanlage ausgelöst" },
      { Stichwort: "BMA - Industrie", Fahrzeuge_AAO: "ELW 1, 2x (H)LF, DLK, TLF", Info: "BMA Industrie" },
      { Stichwort: "Heimrauchmelder", Fahrzeuge_AAO: "(H)LF, DLK (örtlich)", Info: "Ausgelöster Heimrauchmelder" },
      { Stichwort: "CO-Melder", Fahrzeuge_AAO: "(H)LF, GW-Mess / Messen 1", Info: "CO-Alarm/Warner" },

      // TH
      { Stichwort: "TH - 1", Fahrzeuge_AAO: "HLF", Info: "TH klein" },
      { Stichwort: "TH - 2", Fahrzeuge_AAO: "HLF, RW", Info: "TH mittel" },
      { Stichwort: "TH - 3", Fahrzeuge_AAO: "ELW 1, 2x HLF, RW, TLF", Info: "TH groß" },
      { Stichwort: "TH - VU", Fahrzeuge_AAO: "HLF, RW, RTW", Info: "Verkehrsunfall" },
      { Stichwort: "TH - P-klemmt", Fahrzeuge_AAO: "ELW 1, HLF, RW, TLF & NEF, 2x RTW", Info: "VU P eingeklemmt" },
      { Stichwort: "TH - Wasser", Fahrzeuge_AAO: "HLF, Boot, GW-W", Info: "Wasserrettung/-schaden" },
      { Stichwort: "TH - Höhen/Tiefen", Fahrzeuge_AAO: "HLF, RW, Höhenretter", Info: "SRHT" },
      { Stichwort: "TH - Gas 1", Fahrzeuge_AAO: "HLF", Info: "Gasgeruch" },
      { Stichwort: "TH - Gas 2", Fahrzeuge_AAO: "HLF, GW-G/AB-G", Info: "Gasleitung beschädigt" },

      // ABC
      { Stichwort: "ABC - 1", Fahrzeuge_AAO: "HLF, GW-G", Info: "Gefahrstoff klein" },
      { Stichwort: "ABC - 2", Fahrzeuge_AAO: "ELW 1, HLF, GW-G/AB-G, RTW", Info: "Gefahrstoff mittel" },
      { Stichwort: "ABC - 3", Fahrzeuge_AAO: "ELW 2, 2x HLF, GW-G/AB-G, Dekon-P, Messen 2, RTW", Info: "Gefahrstoff groß" },
      { Stichwort: "Messen 1", Fahrzeuge_AAO: "GW-Mess / KdoW (Messung)", Info: "Messtrupp klein" },
      { Stichwort: "Messen 2", Fahrzeuge_AAO: "GW-Mess, ELW 1", Info: "Messtrupp erweitert" },
      { Stichwort: "Dekon-P", Fahrzeuge_AAO: "Dekon-P, HLF", Info: "Dekontamination Personen" },

      // THW
      { Stichwort: "THW - Beleuchtung", Fahrzeuge_AAO: "THW: MzKW/GKW, Anh. Licht", Info: "Einsatzbeleuchtung" },
      { Stichwort: "THW - Pumpen", Fahrzeuge_AAO: "THW: MzKW/GKW, Hochwasserpumpe", Info: "Wasser fördern" },
      { Stichwort: "THW - Räumen", Fahrzeuge_AAO: "THW: Radlader/Bagger, MzKW", Info: "Räumen/Abstützen" },
      { Stichwort: "THW - Eigensicherung", Fahrzeuge_AAO: "THW: GKW, EGS", Info: "Eigentumssicherung" },
      { Stichwort: "THW - Logistik", Fahrzeuge_AAO: "THW: LKW K9, MTW OV", Info: "Logistik/Material" },
      { Stichwort: "THW - Brücke", Fahrzeuge_AAO: "THW: Brückenbau-Trupp", Info: "Behelfsbrücke" },
      { Stichwort: "THW - Fachberater", Fahrzeuge_AAO: "THW: FB OV", Info: "Fachberater THW" },

      // RD
      { Stichwort: "Krankentransport", Fahrzeuge_AAO: "NKTW oder RTW", Info: "Transport ohne Eile" },
      { Stichwort: "Notfall 1", Fahrzeuge_AAO: "RTW oder NKTW", Info: "Allgemeiner Notfall" },
      { Stichwort: "Hilflose Person", Fahrzeuge_AAO: "RTW oder NKTW", Info: "Tür öffnen/Hilfe Person" },
      { Stichwort: "Trauma", Fahrzeuge_AAO: "RTW", Info: "Trauma ohne Polytrauma" },
      { Stichwort: "Notfall 2", Fahrzeuge_AAO: "RTW", Info: "kritischer Notfall" },
      { Stichwort: "Reanimation", Fahrzeuge_AAO: "RTW, NEF (ggf.)", Info: "CPR/Herzstillstand" },
      { Stichwort: "Polytrauma", Fahrzeuge_AAO: "RTH & NEF & RTW", Info: "Schwerstverletzte" },

      // MANV/Sonderlage
      { Stichwort: "MANV-1", Fahrzeuge_AAO: "3x RTW, 2x NEF, 1x NKTW, LF KatS, LNA, San-Zug", Info: "5–9 Verletzte" },
      { Stichwort: "MANV-2", Fahrzeuge_AAO: "+ ORGL, ELRD, Betreuungszug", Info: "10–19 Verletzte" },
      { Stichwort: "MANV-3", Fahrzeuge_AAO: "+ ÄLRD, Versorgungszug", Info: "20–29 Verletzte" },
      { Stichwort: "RDAZ-1", Fahrzeuge_AAO: "2x RTW/NKTW & 1x NEF", Info: "RD-Ausnahmezustand 1" },
      { Stichwort: "AL/TL", Fahrzeuge_AAO: "2x RTW, 1x NEF, LF KatS, LNA, ORGL, San-/Betreuungs-/Führungszug", Info: "Amok/Terror" },
    ];
    const byKey = (k) => AAO.find(e => e.Stichwort.toLowerCase() === (k||'').toLowerCase()) || null;

    const BRAND_SUBS = {
      klein:  ["PKW", "Container", "Kamin", "Garage", "Mülltonne", "Hecke"],
      mittel: ["Wohnung", "Dachstuhl", "Keller", "LKW", "Scheune"],
      gross:  ["Industrie", "Landwirtschaft", "Halle", "Hochhaus"]
    };

    const AAO_ERHOEHUNG_GROUPS = [
      { title:"Lösch-/Rüstfahrzeuge", items:[ {key:"(H)LF",label:"(H)LF"}, {key:"TLF",label:"TLF"}, {key:"RW",label:"RW"}, {key:"DLK",label:"DLK"} ]},
      { title:"Führung BF/FF", items:[ {key:"ELW 1",label:"ELW 1"}, {key:"ELW 2",label:"ELW 2"}, {key:"KdoW A-Dienst",label:"KdoW A-Dienst"}, {key:"KdoW B-Dienst",label:"KdoW B-Dienst"}, {key:"KdoW C-Dienst",label:"KdoW C-Dienst"}, {key:"UG-ÖEL",label:"UG-ÖEL"} ]},
      { title:"Rettungsdienst & Führung RD", items:[ {key:"RTW",label:"RTW"}, {key:"NEF",label:"NEF"}, {key:"NKTW",label:"NKTW"}, {key:"ORGL",label:"ORGL (OrgL RD)"}, {key:"LNA",label:"LNA"}, {key:"ELRD",label:"ELRD"}, {key:"ÄLRD",label:"ÄLRD"}, {key:"UG-Rett",label:"UG-Rett"} ]},
      { title:"Wasser / Gefahrgut / Messen / Dekon", items:[ {key:"GW-G",label:"GW-G"}, {key:"GW-W",label:"GW-W"}, {key:"GW-Mess",label:"GW-Mess"}, {key:"Dekon-P",label:"Dekon-P"} ]},
      { title:"THW", items:[ {key:"THW GKW/MzKW",label:"THW GKW/MzKW"}, {key:"THW Anh. Licht",label:"THW Anh. Licht"}, {key:"THW Hochwasserpumpe",label:"THW Hochwasserpumpe"}, {key:"THW Räumen (Bagger/Radlader)",label:"THW Räumen"}, {key:"THW Logistik (LKW/MTW OV)",label:"THW Logistik"}, {key:"THW Brückenbau",label:"THW Brückenbau"}, {key:"THW Fachberater",label:"THW Fachberater"} ]}
    ];

    const RD_SUBS = ["Krankentransport","Notfall 1","Hilflose Person","Trauma","Notfall 2","Reanimation","Polytrauma"];
    const TH_LIST  = AAO.filter(e => e.Stichwort.startsWith("TH - ")).map(e => e.Stichwort);
    const ABC_LIST = AAO.filter(e => e.Stichwort.startsWith("ABC")).map(e => e.Stichwort).concat(["Messen 1","Messen 2","Dekon-P"]);
    const BMA_LIST = ["BMA","BMA - Industrie","Heimrauchmelder","CO-Melder"];
    const THW_LIST = AAO.filter(e => e.Stichwort.startsWith("THW - ")).map(e => e.Stichwort);

    /* =================== Utils & Validierung =================== */
    const num = (v)=> typeof v === "number" ? v : (v === "" ? 0 : Number(v));
    function brandCodeAndText(fireSize, persons){
      const p = num(persons);
      if (p >= 3) return { code: "B4Y", text: "" };
      if (p === 2) return { code: "B3Y", text: "" };
      if (p === 1) return { code: "B2Y", text: "" };
      if (fireSize === "mittel") return { code: "B2", text: "Mittel" };
      if (fireSize === "gross")  return { code: "B3", text: "Groß" };
      return { code: "B1", text: "Klein" };
    }
    const niceExtra = (x)=>({
      PKW:"PKW-Brand", Container:"Containerbrand", Kamin:"Kaminbrand", Garage:"Garagenbrand",
      Mülltonne:"Mülltonnenbrand", Hecke:"Heckenbrand",
      Wohnung:"Wohnungsbrand", Dachstuhl:"Dachstuhlbrand", Keller:"Kellerbrand", LKW:"LKW-Brand",
      Industrie:"Industriebrand", Landwirtschaft:"Landwirtschaftsbrand", Halle:"Hallenbrand", Hochhaus:"Hochhausbrand"
    }[x] || x);

    function pickAAO(a){
      if (a.category === "MANV/Sonderlage") {
        const v = num(a.personsInDanger);
        if (/(amok|terror|schusswaffe|explosion)/i.test(a.details||"")) return byKey("AL/TL");
        if (v >= 20) return byKey("MANV-3");
        if (v >= 10) return byKey("MANV-2");
        if (v >= 5)  return byKey("MANV-1");
        return byKey("RDAZ-1");
      }
      if (a.category === "Brand") {
        const p = num(a.personsInDanger);
        if (p >= 3) return byKey("B - 4Y");
        if (p === 2) return byKey("B - 3Y");
        if (p === 1) return byKey("B - 2Y");
        if (a.fireSize === "gross")  return byKey("B - 3");
        if (a.fireSize === "mittel") return byKey("B - 2");
        return byKey("B - 1");
      }
      if (a.category === "BMA") return byKey(a.bmaType || "BMA");
      if (a.category === "Technische Hilfe") return byKey(a.thType);
      if (a.category === "ABC") return byKey(a.abcType);
      if (a.category === "THW") return byKey(a.thwType);
      if (a.category === "Rettungsdienst") {
        if (a.rdSub && byKey(a.rdSub)) return byKey(a.rdSub);
        const d = (a.details||"").toLowerCase();
        if ((a.unconscious === "ja" && a.breathing === "nein") || /reani|cpr|herzstillstand/.test(d)) return byKey("Reanimation");
        if (/polytrauma|mehrfachverletz|hochrasanz|sturz\s*>\s*3m/.test(d)) return byKey("Polytrauma");
        if (a.unconscious === "ja" || a.breathing === "nein") return byKey("Notfall 2");
        if (/hilflos|tür|tuere|wohnungstuer|kein kontakt/.test(d)) return byKey("Hilflose Person");
        if (/trauma|sturz|fraktur|blutung/.test(d)) return byKey("Trauma");
        if (/transport|verlegung|ktp|krankentransport/.test(d)) return byKey("Krankentransport");
        return byKey("Notfall 1");
      }
      return null;
    }

    function increaseListFromCounts(counts){
      return Object.entries(counts)
        .filter(([,n]) => n > 0)
        .map(([k,n]) => `+${n} ${k}`);
    }
    function buildVehiclesWithIncrease(base, counts){
      const incList = increaseListFromCounts(counts);
      const inc = incList.length ? " + " + incList.join(", ") : "";
      return (base || "(offen)") + inc;
    }

    function buildMail(a, entry, incCounts){
      const brandExtraLines = (a.category === "Brand")
        ? (BRAND_SUBS[a.fireSize] || []).map(x => `Brand-Zusatz – ${x}: ${a.brandExtras.includes(x) ? "Ja" : "Nein"}`)
        : [];
      const incList = increaseListFromCounts(incCounts);
      const increaseLines = (incList.length ? ["AAO-Erhöhung: " + incList.join(", ")] : []);
      const lines = [
        `Stichwort: ${entry ? entry.Stichwort : "(offen)"}`,
        `AAO Fahrzeuge: ${buildVehiclesWithIncrease(entry?.Fahrzeuge_AAO, incCounts)}`,
        `Info: ${(entry && entry.Info) ? entry.Info : "(keine)"} `,
        `—`,
        `Melder: ${a.callerName || "(unbekannt)"}`,
        `Rückruf: ${a.callbackNumber || "(unbekannt)"}`,
        `Adresse/PLZ: ${a.location || "(unbekannt)"}`,
        `Details: ${a.details || "(keine)"}`,
        `Kategorie: ${a.category || "(unbekannt)"}`,
        `Personen in Gefahr/Verletzt: ${a.personsInDanger === "" ? "(unbekannt)" : a.personsInDanger}`,
        `Bewusst/Atmung (nur RD): ${a.unconscious}/${a.breathing}`,
        `Brandgröße (nur Brand): ${a.fireSize || "(k.A.)"}`,
        `TH-Stichwort: ${a.thType || "(k.A.)"}`,
        `BMA-Typ: ${a.bmaType || "(k.A.)"}`,
        `ABC-Typ: ${a.abcType || "(k.A.)"}`,
        `THW-Typ: ${a.thwType || "(k.A.)"}`,
        `RD-Unterstichwort: ${a.rdSub || "(k.A.)"}`,
        ...(brandExtraLines.length ? ["—", ...brandExtraLines] : []),
        ...(increaseLines.length ? ["—", ...increaseLines] : []),
      ];
      const subject = entry ? entry.Stichwort : "Voranfrage";
      const body = lines.join("\n");
      const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      return { subject, body, mailto };
    }

    /* =================== Validierung =================== */
    function validate(a){
      const errors = [];
      if (!a.category) errors.push({key:"category", msg:"Kategorie wählen.", block:true});
      if (!a.location) errors.push({key:"location", msg:"Adresse/PLZ angeben.", block:true});
      if (a.callbackNumber && !/^[0-9+()\/\-\s]{6,}$/.test(a.callbackNumber))
        errors.push({key:"callbackNumber", msg:"Rückrufnummer wirkt ungültig (mind. 6 Ziffern/Zei.).", block:false});
      if (a.personsInDanger !== "" && (isNaN(a.personsInDanger) || Number(a.personsInDanger) < 0))
        errors.push({key:"personsInDanger", msg:"Anzahl Personen muss eine Zahl ≥ 0 sein.", block:true});

      switch (a.category) {
        case "Brand":
          if (!a.fireSize) errors.push({key:"fireSize", msg:"Brandgröße auswählen (klein/mittel/gross).", block:true});
          break;
        case "BMA":
          if (!a.bmaType) errors.push({key:"bmaType", msg:"BMA-Stichwort auswählen.", block:true});
          break;
        case "Technische Hilfe":
          if (!a.thType) errors.push({key:"thType", msg:"TH-Stichwort auswählen.", block:true});
          break;
        case "ABC":
          if (!a.abcType) errors.push({key:"abcType", msg:"ABC-Stichwort auswählen.", block:true});
          break;
        case "THW":
          if (!a.thwType) errors.push({key:"thwType", msg:"THW-Auftrag auswählen.", block:true});
          break;
        case "Rettungsdienst":
          if (!a.rdSub && !(a.details && a.details.trim().length>2))
            errors.push({key:"rdSub", msg:"RD-Unterstichwort wählen oder Details angeben.", block:false});
          break;
        case "MANV/Sonderlage":
          if (a.personsInDanger === "" || Number(a.personsInDanger) <= 0)
            errors.push({key:"personsInDanger", msg:"Anzahl Verletzte/Betroffene angeben (>0).", block:true});
          break;
      }
      const map = Object.fromEntries(errors.map(e => [e.key, e]));
      const hasBlock = errors.some(e => e.block);
      return { errors, map, hasBlock };
    }

    /* =================== UI-Bausteine =================== */
    const LabeledInput = ({label, value, onChange, type="text", invalid=false, help=""}) => (
      <label className="block mb-3">
        <span className="block text-sm font-medium mb-1">{label}</span>
        <input type={type} className={`w-full border rounded-xl p-2 ${invalid?'invalid':''}`} value={value} onChange={(e)=>onChange(e.target.value)} aria-invalid={invalid}/>
        {invalid && <div className="text-xs text-red-400 mt-1">{help || "Bitte prüfen."}</div>}
      </label>
    );
    const NumberInput = ({label, value, onChange, invalid=false, help=""}) => (
      <label className="block mb-3">
        <span className="block text-sm font-medium mb-1">{label}</span>
        <input type="number" min="0" className={`w-full border rounded-xl p-2 ${invalid?'invalid':''}`} value={value}
               onChange={(e)=>onChange(e.target.value===""?"":Number(e.target.value))} aria-invalid={invalid}/>
        {invalid && <div className="text-xs text-red-400 mt-1">{help || "Bitte Zahl eingeben."}</div>}
      </label>
    );
    const LabeledTextArea = ({label, value, onChange, rows=3, invalid=false, help=""}) => (
      <label className="block mb-3">
        <span className="block text-sm font-medium mb-1">{label}</span>
        <textarea className={`w-full border rounded-xl p-2 ${invalid?'invalid':''}`} rows={rows} value={value} onChange={(e)=>onChange(e.target.value)} aria-invalid={invalid}/>
        {invalid && <div className="text-xs text-red-400 mt-1">{help}</div>}
      </label>
    );

    // ***** SCHWARZES DROPDOWN (Custom Select) *****
    const Select = ({label, value, options, onChange, invalid=false, help=""}) => {
      const [open, setOpen] = React.useState(false);
      const btnRef = React.useRef(null);
      const menuRef = React.useRef(null);
      const idx = Math.max(0, options.findIndex(o => o === value));
      const [active, setActive] = React.useState(idx);

      useEffect(() => {
        function onDocClick(e){
          if (!menuRef.current && !btnRef.current) return;
          if (btnRef.current?.contains(e.target) || menuRef.current?.contains(e.target)) return;
          setOpen(false);
        }
        function onEsc(e){ if (e.key === "Escape") setOpen(false); }
        document.addEventListener("mousedown", onDocClick);
        document.addEventListener("keydown", onEsc);
        return () => {
          document.removeEventListener("mousedown", onDocClick);
          document.removeEventListener("keydown", onEsc);
        };
      }, []);
      useEffect(() => { if (open) setActive(idx); }, [open, idx]);

      function onKeyDown(e){
        if (!open && (e.key === "ArrowDown" || e.key === "Enter" || e.key === " ")) {
          e.preventDefault(); setOpen(true); return;
        }
        if (!open) return;
        if (e.key === "ArrowDown") { e.preventDefault(); setActive(a => Math.min(options.length-1, a+1)); }
        else if (e.key === "ArrowUp") { e.preventDefault(); setActive(a => Math.max(0, a-1)); }
        else if (e.key === "Home")   { e.preventDefault(); setActive(0); }
        else if (e.key === "End")    { e.preventDefault(); setActive(options.length-1); }
        else if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          const val = options[Math.max(0, active)];
          onChange(val);
          setOpen(false);
          btnRef.current?.focus();
        }
      }

      return (
        <label className="block mb-3">
          <span className="block text-sm font-medium mb-1">{label}</span>
          <div className="ds-wrap">
            <button
              type="button"
              ref={btnRef}
              className={`ds-btn ${invalid ? "invalid" : ""}`}
              aria-haspopup="listbox"
              aria-expanded={open}
              onClick={() => setOpen(o => !o)}
              onKeyDown={onKeyDown}
            >
              {value || "— auswählen —"}
            </button>
            <span className="ds-caret">▾</span>

            {open && (
              <div ref={menuRef} className="ds-menu" role="listbox" tabIndex={-1}>
                {options.map((opt, i) => (
                  <div
                    key={opt + i}
                    role="option"
                    aria-selected={i === idx}
                    className={`ds-item ${i === active ? "ds-active" : ""}`}
                    onMouseEnter={() => setActive(i)}
                    onClick={() => { onChange(opt); setOpen(false); btnRef.current?.focus(); }}
                  >
                    {opt || "— auswählen —"}
                  </div>
                ))}
              </div>
            )}
          </div>
          {invalid && <div className="ds-help">{help}</div>}
        </label>
      );
    };

    const Row = ({label, value, multiline=false, children}) => (
      <div>
        <div className="text-xs text-slate-400 flex items-center justify-between">
          <span>{label}</span>
          {children}
        </div>
        {multiline ? <div className="text-sm whitespace-pre-line">{value}</div> : <div className="text-sm">{value}</div>}
      </div>
    );

    /* =================== App =================== */
    function App(){
      const initialState = {
        category: "",
        personsInDanger: "",
        unconscious: "unbekannt",
        breathing: "unbekannt",
        fireSize: "",
        brandExtras: [],
        thType: "",
        bmaType: "",
        abcType: "",
        thwType: "",
        rdSub: "",
        details: "",
        callerName: "",
        callbackNumber: "",
        location: "",
      };
      const [a, setA] = useState(initialState);

      // AAO-Erhöhung
      const [incCounts, setIncCounts] = useState({});
      const incPlus  = (k) => setIncCounts(s => ({...s, [k]: Math.max(0, (s[k]||0)+1)}));
      const incMinus = (k) => setIncCounts(s => ({...s, [k]: Math.max(0, (s[k]||0)-1)}));
      const incReset = () => setIncCounts({});

      const setField = (k, v) => setA(s => ({...s, [k]: v}));
      const { errors, map } = useMemo(()=>validate(a), [a]);

      const entry = useMemo(()=>pickAAO(a), [a]);
      const mail  = useMemo(()=>buildMail(a, entry, incCounts), [a, entry, incCounts]);

      const displayStichwort = useMemo(() => {
        if (a.category !== "Brand") return entry?.Stichwort || "(nicht bestimmt)";
        const { code, text } = brandCodeAndText(a.fireSize, a.personsInDanger);
        const ex = a.brandExtras || [];
        return ex.length ? `${code} ${ex.map(niceExtra).join(" / ")}` : (text ? `${code} ${text}` : code);
      }, [a, entry]);

      const alarm = useMemo(()=>{
        const parts = [];
        if (a.category === "Brand") {
          const { code, text } = brandCodeAndText(a.fireSize, a.personsInDanger);
          const extras = (a.brandExtras || []);
          parts.push(extras.length ? `${code} ${extras.map(niceExtra).join(" / ")}` : (text ? `${code} ${text}` : code));
        } else {
          parts.push(entry?.Stichwort || "(Stichwort)");
        }
        if (a.location) parts.push(a.location);
        const p = num(a.personsInDanger); if (p > 0) parts.push(`P:${p}`);
        if (a.category === "Technische Hilfe" && a.thType) parts.push(`TH:${a.thType}`);
        if (a.category === "BMA" && a.bmaType) parts.push(`BMA:${a.bmaType}`);
        if (a.category === "ABC" && a.abcType) parts.push(`ABC:${a.abcType}`);
        if (a.category === "THW" && a.thwType) parts.push(`THW:${a.thwType}`);
        if (a.category === "Rettungsdienst") {
          if (a.rdSub) parts.push(`RD:${a.rdSub}`);
          if (a.unconscious !== "unbekannt") parts.push(`Bew:${a.unconscious}`);
          if (a.breathing !== "unbekannt") parts.push(`Atm:${a.breathing}`);
        }
        const incList = increaseListFromCounts(incCounts);
        if (incList.length) parts.push("E: " + incList.join(", "));
        const det = (a.details || "").trim(); if (det) parts.push(det.slice(0,60));
        if (a.callbackNumber) parts.push(`RK:${a.callbackNumber}`);
        if (a.callerName) parts.push(`M:${a.callerName}`);
        let text = parts.filter(Boolean).join(" | ").replace(/\s+/g," ").trim();
        if (text.length > 160) text = text.slice(0, 159)+"…";
        return text;
      }, [a, entry, incCounts]);

      const copy = async (t) => { try { await navigator.clipboard.writeText(t || ""); } catch {} };
      const resetAll = () => { setA(initialState); incReset(); };

      /* -------- UI -------- */
      return (
        <div className="min-h-screen p-6">
          <div className="mx-auto max-w-6xl">
            <div className="flex items-center justify-between">
              <h1 className="text-2xl font-bold tracking-tight">Notrufabfrage • AAO</h1>
              <div className="flex gap-2">
                <button className="btn" onClick={resetAll}>Reset alles</button>
              </div>
            </div>

            {errors.length>0 && (
              <div className="mt-3 mb-2 p-3 card">
                <div className="font-semibold text-red-400 mb-1">Bitte prüfen ({errors.length}):</div>
                <ul className="list-disc pl-5 text-sm text-red-300">
                  {errors.map((e,i)=><li key={i}>{e.msg}</li>)}
                </ul>
              </div>
            )}

            <div className="grid lg:grid-cols-3 gap-4 mt-3">
              {/* Eingabe */}
              <section className="lg:col-span-2 card p-4">
                <h2 className="font-semibold mb-3">Einsatzdaten</h2>

                <div className="grid md:grid-cols-2 gap-2">
                  <LabeledInput label="Melder-Name" value={a.callerName} onChange={(v)=>setField("callerName", v)} />
                  <LabeledInput label="Rückrufnummer" value={a.callbackNumber} onChange={(v)=>setField("callbackNumber", v)} invalid={!!map.callbackNumber} help={map.callbackNumber?.msg}/>
                </div>
                <LabeledInput label="Adresse/PLZ" value={a.location} onChange={(v)=>setField("location", v)} invalid={!!map.location} help={map.location?.msg}/>

                <Select label="Kategorie" value={a.category} onChange={(v)=>setField("category", v)} options={["", "Brand", "BMA", "Technische Hilfe", "ABC", "THW", "Rettungsdienst", "MANV/Sonderlage"]} invalid={!!map.category} help={map.category?.msg}/>

                {/* Brand */}
                {a.category === "Brand" && (
                  <div>
                    <div className="grid md:grid-cols-3 gap-2">
                      <Select label="Brandgröße" value={a.fireSize} onChange={(v)=>setField("fireSize", v)} options={["", "klein", "mittel", "gross"]} invalid={!!map.fireSize} help={map.fireSize?.msg}/>
                      <NumberInput label="Personen in Gefahr" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} invalid={!!map.personsInDanger} help={map.personsInDanger?.msg}/>
                      <LabeledInput label="Lage/Details (kurz)" value={a.details} onChange={(v)=>setField("details", v)} />
                    </div>

                    <div className="mt-2">
                      <div className="text-sm font-medium mb-1">Zusatz-Stichworte</div>
                      {(BRAND_SUBS[a.fireSize] || []).length === 0 ? (
                        <div className="text-xs text-slate-400">Bitte zuerst die Brandgröße wählen.</div>
                      ) : (
                        (BRAND_SUBS[a.fireSize] || []).map(x => (
                          <label key={x} className="inline-flex items-center gap-2 mr-3 mb-2">
                            <input type="checkbox" className="w-4 h-4"
                                   checked={a.brandExtras.includes(x)}
                                   onChange={()=>{
                                     const set = new Set(a.brandExtras.filter(e => (BRAND_SUBS[a.fireSize]||[]).includes(e)));
                                     set.has(x) ? set.delete(x) : set.add(x);
                                     setField("brandExtras", [...set]);
                                   }} />
                            <span className="text-sm">{x}</span>
                          </label>
                        ))
                      )}
                    </div>
                  </div>
                )}

                {/* BMA */}
                {a.category === "BMA" && (
                  <div className="grid md:grid-cols-3 gap-2">
                    <Select label="BMA-Typ" value={a.bmaType} onChange={(v)=>setField("bmaType", v)} options={["", ...BMA_LIST]} invalid={!!map.bmaType} help={map.bmaType?.msg}/>
                    <NumberInput label="Personen gefährdet (optional)" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} invalid={!!map.personsInDanger} help={map.personsInDanger?.msg}/>
                    <LabeledInput label="Objekt (z. B. Schule, Industrie…)" value={a.details} onChange={(v)=>setField("details", v)} />
                  </div>
                )}

                {/* TH */}
                {a.category === "Technische Hilfe" && (
                  <div className="grid md:grid-cols-3 gap-2">
                    <Select label="TH-Stichwort" value={a.thType} onChange={(v)=>setField("thType", v)} options={["", ...TH_LIST]} invalid={!!map.thType} help={map.thType?.msg}/>
                    <NumberInput label="Betroffene (optional)" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} invalid={!!map.personsInDanger} help={map.personsInDanger?.msg}/>
                    <LabeledInput label="Details" value={a.details} onChange={(v)=>setField("details", v)} />
                  </div>
                )}

                {/* ABC */}
                {a.category === "ABC" && (
                  <div className="grid md:grid-cols-3 gap-2">
                    <Select label="ABC-Stichwort" value={a.abcType} onChange={(v)=>setField("abcType", v)} options={["", ...ABC_LIST]} invalid={!!map.abcType} help={map.abcType?.msg}/>
                    <NumberInput label="Betroffene (optional)" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} invalid={!!map.personsInDanger} help={map.personsInDanger?.msg}/>
                    <LabeledInput label="Gefahrstoff/UN-Nr. (optional)" value={a.details} onChange={(v)=>setField("details", v)} />
                  </div>
                )}

                {/* THW */}
                {a.category === "THW" && (
                  <div className="grid md:grid-cols-3 gap-2">
                    <Select label="THW-Auftrag" value={a.thwType} onChange={(v)=>setField("thwType", v)} options={["", ...THW_LIST]} invalid={!!map.thwType} help={map.thwType?.msg}/>
                    <NumberInput label="Betroffene (optional)" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} invalid={!!map.personsInDanger} help={map.personsInDanger?.msg}/>
                    <LabeledInput label="Lage/Objekt" value={a.details} onChange={(v)=>setField("details", v)} />
                  </div>
                )}

                {/* RD */}
                {a.category === "Rettungsdienst" && (
                  <div className="grid md:grid-cols-3 gap-2">
                    <Select label="RD-Unterstichwort" value={a.rdSub} onChange={(v)=>setField("rdSub", v)} options={["", ...RD_SUBS]} invalid={!!map.rdSub} help={map.rdSub?.msg}/>
                    <Select label="Bewusstlos?" value={a.unconscious} onChange={(v)=>setField("unconscious", v)} options={["unbekannt","ja","nein"]} />
                    <Select label="Atmung vorhanden?" value={a.breathing} onChange={(v)=>setField("breathing", v)} options={["unbekannt","ja","nein"]} />
                    <NumberInput label="Betroffene/Verletzte" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} invalid={!!map.personsInDanger} help={map.personsInDanger?.msg}/>
                    <LabeledInput label="Details" value={a.details} onChange={(v)=>setField("details", v)} />
                  </div>
                )}

                {/* AAO-Erhöhung */}
                <div className="mt-4">
                  <div className="text-sm font-medium mb-2 flex items-center justify-between">
                    <span>AAO-Erhöhung (Zusatzkräfte)</span>
                    <button type="button" className="btn" onClick={()=>incReset()}>Erhöhung zurücksetzen</button>
                  </div>
                  {AAO_ERHOEHUNG_GROUPS.map(group => (
                    <div key={group.title} className="mb-3">
                      <div className="text-xs font-semibold text-slate-300 mb-1">{group.title}</div>
                      <div className="flex flex-wrap gap-2">
                        {group.items.map(({key, label}) => (
                          <div key={key} className="qty">
                            <button type="button" onClick={()=>incMinus(key)} aria-label={`- ${label}`}>−</button>
                            <span className="text-sm min-w-[1.5rem] text-center">{incCounts[key] || 0}</span>
                            <button type="button" onClick={()=>incPlus(key)} aria-label={`+ ${label}`}>+</button>
                            <span className="text-sm ml-1">{label}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>

                <LabeledTextArea label="Zusatzinfos (frei)" value={a.details} onChange={(v)=>setField("details", v)} rows={3} />
              </section>

              {/* Ergebnis */}
              <section className="lg:col-span-1 card p-4">
                <h2 className="font-semibold mb-3">Ergebnis</h2>

                <Row label="Stichwort" value={displayStichwort}>
                  <button className="btn text-xs" onClick={() => copy(displayStichwort)}>Kopieren</button>
                </Row>

                <Row label="Fahrzeuge" value={buildVehiclesWithIncrease(entry?.Fahrzeuge_AAO, incCounts)}>
                  <button className="btn text-xs" onClick={() => copy(buildVehiclesWithIncrease(entry?.Fahrzeuge_AAO, incCounts))}>Kopieren</button>
                </Row>

                <Row label="Info" value={(entry?.Info) || "(keine)"} multiline />

                {a.category === "Brand" && (
                  <div className="mt-3">
                    <div className="text-xs text-slate-400 flex items-center justify-between">
                      <span>Ausgewählte Brand-Zusätze</span>
                      <button className="btn text-xs" onClick={() => copy((a.brandExtras||[]).join(", "))}>Kopieren</button>
                    </div>
                    <div className="mt-1 flex flex-wrap gap-1">
                      {(BRAND_SUBS[a.fireSize] || []).map(x => (
                        <span key={x} className="badge">{x}: {a.brandExtras.includes(x) ? "Ja" : "Nein"}</span>
                      ))}
                    </div>
                  </div>
                )}

                <div className="border-t border-slate-700 my-3" />
                <h3 className="font-medium mb-1 flex items-center justify-between">
                  <span>Alarmtext (Melder) <span className="text-xs text-slate-400">({(alarm||"").length}/160)</span></span>
                  <button className="btn text-xs" onClick={() => copy(alarm)}>Kopieren</button>
                </h3>
                <textarea className="w-full rounded-2xl p-2 text-sm" rows="4" readOnly value={alarm} />

                <div className="border-t border-slate-700 my-3" />
                <h3 className="font-medium mb-1 flex items-center justify-between">
                  <span>Mailer</span>
                  <div className="flex gap-2">
                    <a href={mail.mailto} className="btn bg-blue-600 text-white text-xs">In E-Mail öffnen</a>
                    <button className="btn text-xs" onClick={() => copy(mail.body)}>Kopieren</button>
                  </div>
                </h3>
                <textarea className="w-full rounded-2xl p-2 text-sm" rows="10" readOnly value={mail.body} />
              </section>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
