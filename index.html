<!DOCTYPE html>
<html lang="de" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notrufabfrage • AAO Kamernstedt (strict)</title>
  <style>
    :root{color-scheme:dark}
    html,body{background:#000;color:#e5e7eb;margin:0}
    .boot{padding:12px;color:#9ca3af}
    .errbox{white-space:pre-wrap;background:#1f2937;color:#fecaca;border:1px solid #ef4444;padding:12px;border-radius:12px;margin:12px}
  </style>
</head>
<body>
  <div id="boot-msg" class="boot">Lade App…</div>
  <div id="root"></div>

  <!-- Schutz vor "schwarzer Bildschirm" -->
  <script>
    (function(){
      function show(t,m){
        var box=document.createElement('div');
        box.className='errbox';
        box.textContent=t+"\n\n"+m;
        document.body.appendChild(box);
      }
      window.addEventListener('error',e=>show('JavaScript-Fehler',(e.message||'')+"\n"+(e.error&&e.error.stack||'')));
      window.addEventListener('unhandledrejection',e=>show('Promise-Fehler',(e.reason&&e.reason.stack)||String(e.reason)));
    })();
  </script>

  <!-- Libs -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class'};</script>

  <!-- App -->
  <script type="text/babel" data-presets="env,react">
    const {useState,useMemo,useEffect}=React;

    /* ===== optische Helfer ===== */
    const css=document.createElement('style');
    css.textContent=`
      .card{background:#0a0a0a;border:1px solid #1f2937;border-radius:1rem}
      .btn{border-radius:1rem;padding:.5rem .75rem;background:#111827;border:1px solid #334155}
      .btn:hover{background:#0f172a}
      .qty{display:inline-flex;align-items:center;gap:.4rem;border:1px solid #334155;border-radius:9999px;padding:.2rem .55rem}
      .qty button{width:1.6rem;height:1.6rem;border-radius:9999px;border:1px solid #334155;line-height:1.6rem}
      .invalid{border-color:#ef4444!important;box-shadow:0 0 0 1px rgba(239,68,68,.25)}
      textarea,input{background:#0b0b0b;border-color:#334155;color:#e5e7eb}
      .ds-wrap{position:relative}
      .ds-btn{width:100%;border:1px solid #334155;border-radius:.75rem;padding:.5rem .75rem;background:#0b0b0b;color:#e5e7eb;text-align:left}
      .ds-btn.invalid{box-shadow:0 0 0 1px rgba(239,68,68,.25);border-color:#ef4444}
      .ds-caret{position:absolute;right:.6rem;top:50%;transform:translateY(-50%);opacity:.7;pointer-events:none}
      .ds-menu{position:absolute;left:0;right:0;top:calc(100% + .25rem);background:#0a0a0a;border:1px solid #334155;border-radius:.75rem;max-height:16rem;overflow:auto;z-index:60;box-shadow:0 10px 30px rgba(0,0,0,.45)}
      .ds-item{padding:.5rem .75rem;cursor:pointer;color:#e5e7eb}
      .ds-item[aria-selected="true"]{background:#0f172a}
      .ds-item:hover,.ds-item.ds-active{background:#111827}
      .subcard{background:#0b0b0b;border:1px solid #1f2937;border-radius:.75rem;padding:.75rem}
      .subhead{font-weight:600;margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem}
      .hint-sm{font-size:.75rem;color:#94a3b8}
      .divider{height:1px;background:#1f2937;margin:.75rem 0}
      .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
      .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.75rem}
      @media (max-width:1024px){.grid2,.grid3{grid-template-columns:1fr}}
      .req::after{content:" *";color:#f87171;font-weight:700}
    `;
    document.head.appendChild(css);

    /* ===== AAO Kamernstedt – 1:1 aus deinen Tabellen ===== */
    const A = (Stichwort,Fahrzeuge_AAO,Info="") => ({Stichwort,Fahrzeuge_AAO,Info});

    const AAO = [
      /* --- Brand (B) --- */
      A("B - 1","TLF oder (H)LF"),
      A("B - 2","ELW, 2x (H)LF, DLK, TLF & RTW oder NKTW"),
      A("B - 3","ELW, 3x (H)LF, DLK, 2x TLF, SW & RTW oder NKTW"),
      A("B - 4","(nach Anforderung durch Einsatzleiter / nach Bedarf)"),
      A("B - 2Y","ELW, 2x (H)LF, DLK, TLF & NEF, 2x RTW oder NKTW"),
      A("B - 3Y","ELW, 3x (H)LF, DLK, 2x TLF, SW & NEF, 3x RTW oder NKTW"),
      A("B - 4Y","ELW, 3x (H)LF, DLK, 2x TLF, SW & 2x NEF, 4x RTW oder NKTW, ORGL + Alarmierung SEG-AZ (Melderschleife)"),
      A("B - 2 Wald","ELW, (H)LF, DLK, 2x TLF & RTW oder NKTW"),
      A("B - 3 Wald","ELW, 2x (H)LF, DLK, 2x TLF, SW & RTW oder NKTW"),
      A("B - Explosion","ELW, (H)LF, DLK, 2x TLF, ELW (HW), GKW, GW Technik, WLF (HW) + Hilfswerk Sprenggruppe & NEF, 2x RTW oder NKTW, ORGL + Alarmierung SEG-AZ (Melderschleife)"),
      A("BMA (Brand)","(H)LF oder TLF"),

      /* --- Technische Hilfe (TH) --- */
      A("TH - Kampfmittel","ELW, HLF, DLK, TLF, ELW (HW), GKW, GW Technik, WLF (HW) + Hilfswerk Sprenggruppe & RTW oder NKTW"),
      A("TH - 1 Einsturz","ELW, HLF, DLK, RW oder AB-Rüst, ELW (HW), GKW, GW Technik & RTW oder NKTW"),
      A("TH - 2 Einsturz","ELW, HLF, DLK, RW, AB-Rüst, ELW (HW), GKW, GW Technik & NEF, 2x RTW oder NKTW"),
      A("TH - Person","ELW, DLK, TLF + Feuerwehr Höhenrettung, ELW (HW), GKW + Hilfswerk Geländeerettung & NEF, 2x RTW oder NKTW"),
      A("TH - Bahn","ELW, HLF, DLK, RW, AB-Rüst, ELW (HW), GKW, GW Technik, WLF (HW), & 2x NEF, 4x RTW oder NKTW + ORGL, LNA + KatSchutz-Führung + Alarmierung SEG-AZ (Melderschleife)"),
      A("TH - klein","HLF oder GKW oder RW oder GW Technik"),
      A("TH - groß","ELW oder ELW (HW), HLF, DLK, RW oder GW Technik, AB-Rüst, GKW"),
      A("TH - P-klemmt","ELW oder ELW (HW), HLF oder GKW, RW oder GW Technik, TLF & NEF, 2x RTW oder NKTW"),
      A("TH - P-klemmt 2","ELW oder ELW (HW), 2x HLF oder GKW, RW oder GW Technik, TLF & NEF, 3x RTW oder NKTW"),
      A("TH - Wasser","(H)LF oder GKW"),
      A("TH - Wasser P","ELW oder ELW (HW), (H)LF oder GKW, DLK, RW oder GW Technik, + Feuerwehr Wasserrettung + Hilfswerk Wasserrettung & RTH, NEF, 2x RTW oder NKTW"),
      A("TH - Gas 1","HLF"),
      A("TH - Gas 2","HLF, GW-G oder AB-G"),

      /* --- ABC aus deiner TH/ABC-Tafel --- */
      A("ABC 1","HLF oder GKW"),
      A("ABC 2","HLF oder GKW, GW-G oder AB-G"),
      A("ABC 3","ELW, HLF, DLK, TLF, GW-G oder AB-G, ELW (HW), GKW, WLF (HW) + Hilfswerk CBRN Einheit & RTW oder NKTW"),
      A("ABC 3 F","ELW, HLF, DLK, TLF, GW-G oder AB-G, ELW (HW), GKW, WLF (HW) + Hilfswerk CBRN Einheit & NEF, RTW oder NKTW"),
      A("ABC 4 Person","ELW, HLF, DLK, TLF, GW-G oder AB-G, ELW (HW), GKW, WLF (HW) + Hilfswerk CBRN Einheit & NEF, 2x RTW oder NKTW + Alarmierung SEG-AZ (Melderschleife)"),
      A("ABC 4 F Person","ELW, HLF, DLK, TLF, GW-G oder AB-G, ELW (HW), GKW, GW Technik, WLF (HW) + Hilfswerk CBRN Einheit & RTH, NEF, 2x RTW oder NKTW + KatSchutz-Führung"),
      A("ABC 5 V-Dekon","ELW, HLF, DLK, TLF, GW-G oder AB-G, ELW (HW), GKW, GW Technik, WLF (HW) + Hilfswerk CBRN Einheit & RTH, 2x NEF, 4x RTW oder NKTW & ORGL, LNA + KatSchutz-Führung + Alarmierung SEG-AZ (Melderschleife)"),

      /* --- BMA (eigenes Kapitel) --- */
      A("BMA","ELW 1, (H)LF, DLK (bei Bedarf)"),
      A("BMA - Industrie","ELW 1, 2x (H)LF, DLK, TLF"),
      A("Heimrauchmelder","(H)LF, DLK (örtlich)"),
      A("CO-Melder","(H)LF, GW-Mess / Messen 1"),

      /* --- S (ORG/PSNV/KIT) --- */
      A("S - ORG","nach Bedarf"),
      A("S - PSNV","nach Bedarf"),
      A("S - KIT","nach Bedarf"),

      /* --- K / NT --- */
      A("K - 1","NKTW oder RTW"),
      A("K - 2","NKTW oder RTW"),
      A("NT","NKTW oder RTW"),

      /* --- RD N1 / N2 / N2p (aus Tabellen) --- */
      // N1 – immer „RTW oder NKTW“
      ...["HILOP","TRAUMA","INTER","CHIRUR","NEURO","KARDIO","PNEUMO","GYN / URO","PSYCH","SONST"]
        .map(x=>A(`N1 - ${x}`,"RTW oder NKTW")),
      A("N1 - NachF","nach Bedarf"),
      A("N1 - BEREIT","RTW oder NKTW"),

      // N2 – „NEF & RTW oder NKTW“
      ...["REA","TRAUMA","INTER","CHIRUR","NEURO","KARDIO","PNEUMO","GYN / URO","PSYCH","SONST","SUIZID","INTOX"]
        .map(x=>A(`N2 - ${x}`,"NEF & RTW oder NKTW")),
      A("N2 - BEREIT","NEF & RTW oder NKTW"),
      A("N2 - NachF","nach Bedarf"),

      // N2p – Poly/sonst/Bereit/NachF
      A("N2p - POLY","RTH & NEF & RTW oder NKTW"),
      A("N2p - SONST","RTH & NEF & RTW oder NKTW"),
      A("N2p - BEREIT","RTH & NEF & RTW oder NKTW"),
      A("N2p - NachF","nach Bedarf"),

      /* --- Verlegungen --- */
      A("VR","RTW oder NKTW"),
      A("VN","NEF & RTW oder ITW oder NAW oder ITH"),

      /* --- SOLA / MANV – Einsatzlagen --- */
      A("MANV-1","3x RTW, 2x NEF, 1x NKTW, LF 20 KatS, LNA, ORGL, Sanitätszug"),
      A("MANV-2","3x RTW, 2x NEF, 1x NKTW, LF 20 KatS, LNA, ORGL, ELRD, ÄLRD, Sanitätszug, Betreuungszug"),
      A("MANV-3","3x RTW, 2x NEF, 1x NKTW, LF 20 KatS, LNA, ORGL, ELRD, ÄLRD, Sanitätszug, Versorgungszug, Führungszug"),
      A("MANV-4","3x RTW, 2x NEF, 1x NKTW, LF 20 KatS, LNA, ORGL, ELRD, ÄLRD, Sanitätszug, Betreuungszug, Versorgungszug, Führungszug"),
      A("MANV-E","3x RTW, 2x NEF, 1x NKTW, LF 20 KatS, LNA, ORGL, Sanitätszug, Betreuungszug")
    ];

    const byKey = k => AAO.find(e => e.Stichwort.toLowerCase() === (k||"").toLowerCase()) || null;

    /* -------- Listen für Auswahlfelder -------- */
    const TH_LIST = [
      "TH - Kampfmittel","TH - 1 Einsturz","TH - 2 Einsturz","TH - Person","TH - Bahn","TH - klein","TH - groß",
      "TH - P-klemmt","TH - P-klemmt 2","TH - Wasser","TH - Wasser P","TH - Gas 1","TH - Gas 2"
    ];
    const ABC_LIST = ["ABC 1","ABC 2","ABC 3","ABC 3 F","ABC 4 Person","ABC 4 F Person","ABC 5 V-Dekon"];
    const BMA_LIST = ["BMA","BMA - Industrie","Heimrauchmelder","CO-Melder"];
    const RD_SUBS = [
      "K - 1","K - 2","NT",
      "N1 - HILOP","N1 - TRAUMA","N1 - INTER","N1 - CHIRUR","N1 - NEURO","N1 - KARDIO","N1 - PNEUMO","N1 - GYN / URO","N1 - PSYCH","N1 - SONST","N1 - NachF","N1 - BEREIT",
      "N2 - REA","N2 - TRAUMA","N2 - INTER","N2 - CHIRUR","N2 - NEURO","N2 - KARDIO","N2 - PNEUMO","N2 - GYN / URO","N2 - PSYCH","N2 - SONST","N2 - SUIZID","N2 - INTOX","N2 - BEREIT","N2 - NachF",
      "N2p - POLY","N2p - SONST","N2p - BEREIT","N2p - NachF",
      "VR","VN"
    ];

    /* ===== Logik ===== */
    const num = v => typeof v==="number"?v:(v===""?0:Number(v));
    const niceExtra = x => ({PKW:"PKW-Brand",Container:"Containerbrand",Kamin:"Kaminbrand",Garage:"Garagenbrand",Mülltonne:"Mülltonnenbrand",Hecke:"Heckenbrand",Wohnung:"Wohnungsbrand",Dachstuhl:"Dachstuhlbrand",Keller:"Kellerbrand",LKW:"LKW-Brand",Industrie:"Industriebrand",Landwirtschaft:"Landwirtschaftsbrand",Halle:"Hallenbrand",Hochhaus:"Hochhausbrand",Scheune:"Scheunenbrand"}[x]||x);
    const BRAND_SUBS = {klein:["PKW","Container","Kamin","Garage","Mülltonne","Hecke"],mittel:["Wohnung","Dachstuhl","Keller","LKW","Scheune"],gross:["Industrie","Landwirtschaft","Halle","Hochhaus"]};

    function brandCodeAndText(size,persons){
      const p=num(persons);
      if(p>=3) return {code:"B - 4Y",text:""};
      if(p===2) return {code:"B - 3Y",text:""};
      if(p===1) return {code:"B - 2Y",text:""};
      if(size==="gross") return {code:"B - 3",text:""};
      if(size==="mittel") return {code:"B - 2",text:""};
      return {code:"B - 1",text:""};
    }

    const manvFromPersons = n => {const v=Number(n||0);if(v>=20)return"MANV-3";if(v>=10)return"MANV-2";if(v>=5)return"MANV-1";return""};
    function autoRTWCounts(a){
      if(a.category!=="Rettungsdienst")return {};
      const p=Number(a.personsInDanger||0);
      if(!Number.isFinite(p)||p<=1)return {};
      if(p>=5)return {};               // ab 5 → MANV übernimmt
      return {RTW:p-1};               // bis 4 Pat. => +RTW
    }
    function autoMANVEntry(a){
      if(a.category!=="Rettungsdienst")return null;
      const key=manvFromPersons(a.personsInDanger);
      return key?byKey(key):null;
    }
    function combineVehicles(base, extra) {
      const b=(base||"").trim(), ex=(extra&&(extra.Fahrzeuge_AAO||"").trim())||"";
      if(!b && !ex) return "(offen)";
      if(!b) return ex;
      if(!ex) return b;
      return `${b} + ${ex}`;
    }
    function combineVehiclesMulti(base, extras=[]) {
      return extras.reduce((acc,e)=>combineVehicles(acc,e),(base||"").trim());
    }
    const mergeCounts=(a,b)=>{const o={...a};Object.entries(b||{}).forEach(([k,n])=>o[k]=(o[k]||0)+n);return o;};
    const incList=c=>Object.entries(c).filter(([,n])=>n>0).map(([k,n])=>`+${n} ${k}`);
    const buildVehiclesWithIncrease=(base,counts)=> (base||"(offen)") + (incList(counts).length?` + ${incList(counts).join(", ")}`:"");

    function pickAAO(a){
      if(a.category==="Brand"){
        const {code}=brandCodeAndText(a.fireSize,a.personsInDanger);
        return byKey(code);
      }
      if(a.category==="BMA") return byKey(a.bmaType||"BMA");
      if(a.category==="Technische Hilfe") return byKey(a.thType);
      if(a.category==="ABC") return byKey(a.abcType);
      if(a.category==="Rettungsdienst"){
        if(a.rdSub) return byKey(a.rdSub);
        return byKey("N1 - SONST"); // Fallback
      }
      return null;
    }

    function buildMail(a,entry,counts,extras){
      const extraStw = extras.map(e=>e.Stichwort).join(" + ");
      const combined = combineVehiclesMulti(entry?.Fahrzeuge_AAO || "", extras);
      const lines = [
        `Stichwort: ${entry ? entry.Stichwort : "(offen)"}${extraStw? " + " + extraStw : ""}`,
        `AAO Fahrzeuge: ${buildVehiclesWithIncrease(combined, counts)}`,
        `—`,
        `Details: ${a.details || "(keine)"}`,
        `Kategorie: ${a.category || "(unbekannt)"}`,
        `Personen/Patienten gesamt: ${a.personsInDanger === "" ? "(unbekannt)" : a.personsInDanger}`,
        ...(a.category==="Rettungsdienst"?[
          `Bewusst/Atmung: ${a.unconscious}/${a.breathing}`,
          `RD-Unterstichwort: ${a.rdSub || "(k.A.)"}`
        ]:[])
      ];
      const subject=(entry ? entry.Stichwort : "Voranfrage")+(extraStw? " + "+extraStw:"");
      return {subject,body:lines.join("\n"),mailto:`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(lines.join("\n"))}`};
    }

    /* ===== UI ===== */
    const LabeledInput=({label,value,onChange,type="text",invalid=false,help=""})=>(
      <label className="block">
        <span className="block text-sm font-medium mb-1">{label}</span>
        <input type={type} className={`w-full border rounded-xl p-2 ${invalid?'invalid':''}`} value={value}
               onChange={(e)=>onChange(e.target.value)} aria-invalid={invalid}/>
        {invalid&&<div className="text-xs text-red-400 mt-1">{help||"Bitte prüfen."}</div>}
      </label>
    );
    const NumberInput=({label,value,onChange,invalid=false,help=""})=>(
      <label className="block">
        <span className="block text-sm font-medium mb-1">{label}</span>
        <input type="number" min="0" className={`w-full border rounded-xl p-2 ${invalid?'invalid':''}`}
               value={value} onChange={(e)=>onChange(e.target.value===""?"":Number(e.target.value))}
               aria-invalid={invalid}/>
        {invalid&&<div className="text-xs text-red-400 mt-1">{help||"Bitte Zahl eingeben."}</div>}
      </label>
    );
    const Select=({label,value,options,onChange,invalid=false,help=""})=>{
      const[open,setOpen]=useState(false);const btnRef=React.useRef(null);const menuRef=React.useRef(null);
      const idx=Math.max(0,options.findIndex(o=>o===value));const[active,setActive]=useState(idx);
      useEffect(()=>{function onDoc(e){if(btnRef.current?.contains(e.target)||menuRef.current?.contains(e.target))return;setOpen(false)}
        function onEsc(e){if(e.key==="Escape")setOpen(false)}
        document.addEventListener('mousedown',onDoc);document.addEventListener('keydown',onEsc);
        return()=>{document.removeEventListener('mousedown',onDoc);document.removeEventListener('keydown',onEsc)}},[]);
      useEffect(()=>{if(open)setActive(idx)},[open,idx]);
      function onKeyDown(e){
        if(!open&&(e.key==="ArrowDown"||e.key==="Enter"||e.key===" ")){e.preventDefault();setOpen(true);return}
        if(!open)return;
        if(e.key==="ArrowDown"){e.preventDefault();setActive(a=>Math.min(options.length-1,a+1))}
        else if(e.key==="ArrowUp"){e.preventDefault();setActive(a=>Math.max(0,a-1))}
        else if(e.key==="Home"){e.preventDefault();setActive(0)}
        else if(e.key==="End"){e.preventDefault();setActive(options.length-1)}
        else if(e.key==="Enter"||e.key===" "){e.preventDefault();const val=options[Math.max(0,active)];onChange(val);setOpen(false);btnRef.current?.focus()}
      }
      useEffect(()=>{if(!open||!menuRef.current)return;const el=menuRef.current.querySelector('.ds-item.ds-active');if(el){const m=menuRef.current;const top=el.offsetTop,bottom=top+el.offsetHeight;if(top<m.scrollTop)m.scrollTop=top;else if(bottom>m.scrollTop+m.clientHeight)m.scrollTop=bottom-m.clientHeight}},[open,active]);
      return(
        <label className="block">
          <span className="block text-sm font-medium mb-1">{label}</span>
          <div className="ds-wrap">
            <button type="button" ref={btnRef} className={`ds-btn ${invalid?"invalid":""}`} aria-haspopup="listbox" aria-expanded={open}
                    onClick={()=>setOpen(o=>!o)} onKeyDown={onKeyDown}>{value||"— auswählen —"}</button>
            <span className="ds-caret">▾</span>
            {open&&(
              <div ref={menuRef} className="ds-menu" role="listbox" tabIndex={-1}>
                {options.map((opt,i)=>(
                  <div key={opt+i} role="option" aria-selected={i===idx}
                       className={`ds-item ${i===active?"ds-active":""}`}
                       onMouseEnter={()=>setActive(i)}
                       onClick={()=>{onChange(opt);setOpen(false);btnRef.current?.focus();}}>
                    {opt||"— auswählen —"}
                  </div>
                ))}
              </div>
            )}
          </div>
          {invalid&&<div className="text-xs text-red-400 mt-1">{help}</div>}
        </label>
      );
    };
    function Section({title,hint,children}){return(
      <div className="subcard mb-3">
        <div className="subhead"><span>{title}</span>{hint?<span className="hint-sm">· {hint}</span>:null}</div>
        {children}
      </div>
    );}

    /* ===== App ===== */
    function App(){
      const initial={category:"",personsInDanger:"",unconscious:"unbekannt",breathing:"unbekannt",fireSize:"",brandExtras:[],thType:"",bmaType:"",abcType:"",rdSub:"",details:"",manvActive:false,manvAuto:true,manvLevel:""};
      const[a,setA]=useState(initial);
      const[inc,setInc]=useState({});
      const incPlus=k=>setInc(s=>({...s,[k]:Math.max(0,(s[k]||0)+1)}));
      const incMinus=k=>setInc(s=>({...s,[k]:Math.max(0,(s[k]||0)-1)}));
      const incReset=()=>setInc({});

      const setField=(k,v)=>setA(s=>({...s,[k]:v}));

      const errors=useMemo(()=>{
        const out=[];if(!a.category)out.push({key:"category",msg:"Kategorie wählen."});
        const z=a.personsInDanger;if(z!==""&&(isNaN(z)||Number(z)<0))out.push({key:"personsInDanger",msg:"Anzahl muss Zahl ≥ 0 sein."});
        if(a.category==="Brand"&&!a.fireSize)out.push({key:"fireSize",msg:"Brandgröße wählen."});
        if(a.category==="BMA"&&!a.bmaType)out.push({key:"bmaType",msg:"BMA-Stichwort wählen."});
        if(a.category==="Technische Hilfe"&&!a.thType)out.push({key:"thType",msg:"TH-Stichwort wählen."});
        if(a.category==="ABC"&&!a.abcType)out.push({key:"abcType",msg:"ABC-Stichwort wählen."});
        if(a.category==="Rettungsdienst"&&!a.rdSub&&!(a.details&&a.details.trim().length>2))out.push({key:"rdSub",msg:"RD-Unterstichwort wählen oder Details angeben."});
        return out;
      },[a]);
      const invalid=Object.fromEntries(errors.map(e=>[e.key,e.msg]));

      const entry=useMemo(()=>pickAAO(a),[a]);
      const autoCounts=useMemo(()=>autoRTWCounts(a),[a]);
      const autoManv=useMemo(()=>autoMANVEntry(a),[a]);
      const manualManvKey=useMemo(()=>{
        if(!a.manvActive)return"";
        if(a.manvAuto)return manvFromPersons(a.personsInDanger);
        return a.manvLevel||"";
      },[a.manvActive,a.manvAuto,a.manvLevel,a.personsInDanger]);
      const manualManv=useMemo(()=>manualManvKey?byKey(manualManvKey):null,[manualManvKey]);
      const extras=useMemo(()=>{
        const list=[];if(manualManv)list.push(manualManv);
        if(autoManv && !list.find(x=>x.Stichwort===autoManv.Stichwort))list.push(autoManv);
        return list;
      },[manualManv,autoManv]);

      const totalCounts=useMemo(()=>mergeCounts(inc,autoCounts),[inc,autoCounts]);

      const displayStichwort=useMemo(()=>{
        let base="";
        if(a.category==="Brand"){
          const {code}=brandCodeAndText(a.fireSize,a.personsInDanger);
          const ex=a.brandExtras||[];base=ex.length?`${code} ${ex.map(niceExtra).join(" / ")}`:code;
        }else if(a.category==="MANV/Sonderlage"){
          const extraTxt = extras.map(e=>e.Stichwort).join(" + "); base = extraTxt || "(MANV wählen)";
        }else{
          base=entry?.Stichwort||"(nicht bestimmt)";
        }
        const extraTxt=extras.map(e=>e.Stichwort).join(" + ");
        if(extraTxt && a.category!=="MANV/Sonderlage") base+=` + ${extraTxt}`;
        return base;
      },[a,entry,extras]);

      const alarm=useMemo(()=>{
        const parts=[];
        if(a.category==="Brand"){
          const {code}=brandCodeAndText(a.fireSize,a.personsInDanger);
          const ex=a.brandExtras||[];parts.push(ex.length?`${code} ${ex.map(niceExtra).join(" / ")}`:code);
        }else if(a.category==="MANV/Sonderlage"){
          extras.forEach(e=>parts.push(e.Stichwort));
        }else{
          parts.push(entry?.Stichwort||"(Stichwort)"); extras.forEach(e=>parts.push(e.Stichwort));
        }
        const p=num(a.personsInDanger);if(p>0)parts.push(`P:${p}`);
        if(a.category==="Rettungsdienst"){
          if(a.rdSub)parts.push(`RD:${a.rdSub}`);
          if(a.unconscious!=="unbekannt")parts.push(`Bew:${a.unconscious}`);
          if(a.breathing!=="unbekannt")parts.push(`Atm:${a.breathing}`);
        }
        const det=(a.details||"").trim();if(det)parts.push(det.slice(0,60));
        let out=parts.filter(Boolean).join(" | ").replace(/\s+/g," ").trim();
        if(out.length>160)out=out.slice(0,159)+"…";
        return out;
      },[a,entry,extras]);

      const mail=useMemo(()=>buildMail(a,entry,totalCounts,extras),[a,entry,totalCounts,extras]);

      useEffect(()=>{document.getElementById('boot-msg')?.remove();},[]);

      const copy=async t=>{try{await navigator.clipboard.writeText(t||"")}catch{}};
      const reset=()=>{setA(initial);setInc({});};

      return (
        <div className="min-h-screen p-6">
          <div className="mx-auto max-w-6xl">
            <div className="flex items-center justify-between">
              <h1 className="text-2xl font-bold tracking-tight">Notrufabfrage • AAO Kamernstedt (strict)</h1>
              <button className="btn" onClick={reset}>Reset</button>
            </div>

            {errors.length>0&&(
              <div className="mt-3 mb-2 p-3 card">
                <div className="font-semibold text-red-400 mb-1">Bitte prüfen ({errors.length}):</div>
                <ul className="list-disc pl-5 text-sm text-red-300">{errors.map((e,i)=><li key={i}>{e.msg}</li>)}</ul>
              </div>
            )}

            <div className="grid lg:grid-cols-3 gap-4 mt-3">
              {/* Eingaben */}
              <section className="lg:col-span-2 card p-4">
                <h2 className="font-semibold mb-3">Einsatzdaten</h2>

                <Section title="Kategorie" hint="steuert Folgefelder">
                  <div className="grid2">
                    <Select label={<span className="req">Kategorie</span>} value={a.category} onChange={v=>setField("category",v)}
                            options={["","Brand","BMA","Technische Hilfe","ABC","Rettungsdienst","MANV/Sonderlage"]}
                            invalid={!!invalid.category} help={invalid.category}/>
                    <LabeledInput label="Kurzlage (optional)" value={a.details} onChange={v=>setField("details",v)}/>
                  </div>
                </Section>

                {a.category==="Brand"&&(
                  <Section title="Brand" hint="Größe + optional Objekt">
                    <div className="grid3">
                      <Select label={<span className="req">Brandgröße</span>} value={a.fireSize} onChange={v=>setField("fireSize",v)}
                              options={["","klein","mittel","gross"]} invalid={!!invalid.fireSize} help={invalid.fireSize}/>
                      <NumberInput label="Personen in Gefahr" value={a.personsInDanger} onChange={v=>setField("personsInDanger",v)}
                                   invalid={!!invalid.personsInDanger} help={invalid.personsInDanger}/>
                      <LabeledInput label="Objekt (optional)" value={a.details} onChange={v=>setField("details",v)}/>
                    </div>
                    {(BRAND_SUBS[a.fireSize]||[]).length>0&&(
                      <>
                        <div className="divider"></div>
                        <div className="subhead">Zusatz-Stichworte</div>
                        <div className="flex flex-wrap gap-2">
                          {(BRAND_SUBS[a.fireSize]||[]).map(x=>(
                            <label key={x} className="inline-flex items-center gap-2">
                              <input type="checkbox" className="w-4 h-4"
                                checked={(a.brandExtras||[]).includes(x)}
                                onChange={()=>{const s=new Set(a.brandExtras||[]);s.has(x)?s.delete(x):s.add(x);setField("brandExtras",[...s])}}/>
                              <span className="text-sm">{x}</span>
                            </label>
                          ))}
                        </div>
                      </>
                    )}
                  </Section>
                )}

                {a.category==="BMA"&&(
                  <Section title="BMA">
                    <div className="grid3">
                      <Select label={<span className="req">BMA-Typ</span>} value={a.bmaType} onChange={v=>setField("bmaType",v)}
                              options={["",...BMA_LIST]} invalid={!!invalid.bmaType} help={invalid.bmaType}/>
                      <NumberInput label="Gefährdete (optional)" value={a.personsInDanger} onChange={v=>setField("personsInDanger",v)}
                                   invalid={!!invalid.personsInDanger} help={invalid.personsInDanger}/>
                      <LabeledInput label="Objekt (optional)" value={a.details} onChange={v=>setField("details",v)}/>
                    </div>
                  </Section>
                )}

                {a.category==="Technische Hilfe"&&(
                  <Section title="Technische Hilfe">
                    <div className="grid3">
                      <Select label={<span className="req">TH-Stichwort</span>} value={a.thType} onChange={v=>setField("thType",v)}
                              options={["",...TH_LIST]} invalid={!!invalid.thType} help={invalid.thType}/>
                      <NumberInput label="Betroffene (optional)" value={a.personsInDanger} onChange={v=>setField("personsInDanger",v)}
                                   invalid={!!invalid.personsInDanger} help={invalid.personsInDanger}/>
                      <LabeledInput label="Details (optional)" value={a.details} onChange={v=>setField("details",v)}/>
                    </div>
                  </Section>
                )}

                {a.category==="ABC"&&(
                  <Section title="ABC">
                    <div className="grid3">
                      <Select label={<span className="req">ABC-Stichwort</span>} value={a.abcType} onChange={v=>setField("abcType",v)}
                              options={["",...ABC_LIST]} invalid={!!invalid.abcType} help={invalid.abcType}/>
                      <NumberInput label="Betroffene (optional)" value={a.personsInDanger} onChange={v=>setField("personsInDanger",v)}
                                   invalid={!!invalid.personsInDanger} help={invalid.personsInDanger}/>
                      <LabeledInput label="Gefahrstoff/UN (optional)" value={a.details} onChange={v=>setField("details",v)}/>
                    </div>
                  </Section>
                )}

                {a.category==="Rettungsdienst"&&(
                  <Section title="Rettungsdienst" hint="Skalierung bis 4 Pat.: +RTW; ab 5 Pat. → MANV">
                    <div className="grid3">
                      <Select label="RD-Unterstichwort" value={a.rdSub} onChange={v=>setField("rdSub",v)}
                              options={["",...RD_SUBS]} invalid={!!invalid.rdSub} help={invalid.rdSub}/>
                      <Select label="Bewusstlos?" value={a.unconscious} onChange={v=>setField("unconscious",v)} options={["unbekannt","ja","nein"]}/>
                      <Select label="Atmung vorhanden?" value={a.breathing} onChange={v=>setField("breathing",v)} options={["unbekannt","ja","nein"]}/>
                    </div>
                    <div className="grid2 mt-2">
                      <NumberInput label="Patienten gesamt" value={a.personsInDanger} onChange={v=>setField("personsInDanger",v)}
                                   invalid={!!invalid.personsInDanger} help={invalid.personsInDanger}/>
                      <LabeledInput label="Details (optional)" value={a.details} onChange={v=>setField("details",v)}/>
                    </div>
                  </Section>
                )}

                {/* MANV / Sonderlagen */}
                <details className="subcard mb-3" open>
                  <summary className="subhead">MANV (Sonderlage)</summary>
                  <div className="grid2">
                    <label className="inline-flex items-center gap-2">
                      <input type="checkbox" className="w-4 h-4" checked={a.manvActive} onChange={e=>setField("manvActive",e.target.checked)}/>
                      <span>MANV zuschalten</span>
                    </label>
                    <label className="inline-flex items-center gap-2">
                      <input type="checkbox" className="w-4 h-4" checked={a.manvAuto} onChange={e=>setField("manvAuto",e.target.checked)} disabled={!a.manvActive}/>
                      <span>MANV automatisch (nach Personen)</span>
                    </label>
                  </div>
                  <div className="grid3 mt-2">
                    <Select label="MANV-Level (manuell)" value={a.manvLevel} onChange={v=>setField("manvLevel",v)}
                            options={["","MANV-1","MANV-2","MANV-3","MANV-4","MANV-E"]}/>
                  </div>
                </details>

                {/* AAO-Erhöhung */}
                <Section title="AAO-Erhöhung (Ergänzungsfahrzeuge)" hint="manuell zubuchen">
                  <div className="divider"></div>
                  {[
                    {title:"Lösch-/Rüstfahrzeuge",items:[{key:"(H)LF",label:"(H)LF"},{key:"TLF",label:"TLF"},{key:"RW",label:"RW"},{key:"DLK",label:"DLK"},{key:"ELW 1",label:"ELW 1"},{key:"ELW 2",label:"ELW 2"}]},
                    {title:"Rettungsdienst",items:[{key:"RTW",label:"RTW"},{key:"NEF",label:"NEF"},{key:"NKTW",label:"NKTW"},{key:"ORGL",label:"ORGL"},{key:"LNA",label:"LNA"},{key:"ELRD",label:"ELRD"},{key:"ÄLRD",label:"ÄLRD"}]},
                    {title:"Spezial",items:[{key:"GW-G",label:"GW-G"},{key:"GW-W",label:"GW-W"},{key:"GW-Mess",label:"GW-Mess"},{key:"Dekon-P",label:"Dekon-P"},{key:"Boot",label:"Boot"}]}
                  ].map(group=>(
                    <div key={group.title} className="mb-3">
                      <div className="text-xs font-semibold text-slate-300 mb-1">{group.title}</div>
                      <div className="flex flex-wrap gap-2">
                        {group.items.map(({key,label})=>(
                          <div key={key} className="qty">
                            <button type="button" onClick={()=>incMinus(key)} aria-label={`- ${label}`}>−</button>
                            <span className="text-sm min-w-[1.5rem] text-center">{inc[key]||0}</span>
                            <button type="button" onClick={()=>incPlus(key)} aria-label={`+ ${label}`}>+</button>
                            <span className="text-sm ml-1">{label}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                  <div className="mt-2"><button type="button" className="btn" onClick={incReset}>Erhöhung zurücksetzen</button></div>
                </Section>
              </section>

              {/* Ergebnis */}
              <section className="lg:col-span-1 card p-4">
                <h2 className="font-semibold mb-3">Ergebnis</h2>

                <div className="mb-2">
                  <div className="text-xs text-slate-400">Stichwort</div>
                  <div className="text-sm">{/* Anzeige */}
                    {(() => {
                      const ex = extras.map(e=>e.Stichwort).join(" + ");
                      const base = (a.category==="Brand"
                        ? (()=>{const {code}=brandCodeAndText(a.fireSize,a.personsInDanger);const add=(a.brandExtras||[]).map(niceExtra);return add.length?`${code} ${add.join(" / ")}`:code;})()
                        : (entry?.Stichwort||"(nicht bestimmt)"));
                      return ex && a.category!=="MANV/Sonderlage" ? `${base} + ${ex}` : (a.category==="MANV/Sonderlage" ? (ex||"(MANV wählen)") : base);
                    })()}
                  </div>
                  <div className="mt-1"><button className="btn text-xs" onClick={()=>navigator.clipboard.writeText(
                    (()=>{const ex=extras.map(e=>e.Stichwort).join(" + ");const base=(a.category==="Brand"?(()=>{const {code}=brandCodeAndText(a.fireSize,a.personsInDanger);const add=(a.brandExtras||[]).map(niceExtra);return add.length?`${code} ${add.join(" / ")}`:code;})():(entry?.Stichwort||"(nicht bestimmt)"));return ex&&a.category!=="MANV/Sonderlage"?`${base} + ${ex}`:(a.category==="MANV/Sonderlage"?(ex||"(MANV wählen)"):base);})()
                  )}>Kopieren</button></div>
                </div>

                <div className="mb-2">
                  <div className="text-xs text-slate-400">Fahrzeuge</div>
                  <div className="text-sm">
                    {buildVehiclesWithIncrease(
                      combineVehiclesMulti(entry?.Fahrzeuge_AAO || "", extras),
                      totalCounts
                    )}
                  </div>
                  <div className="mt-1">
                    <button className="btn text-xs" onClick={()=>{
                      const txt=buildVehiclesWithIncrease(combineVehiclesMulti(entry?.Fahrzeuge_AAO || "", extras),totalCounts);
                      navigator.clipboard.writeText(txt);
                    }}>Kopieren</button>
                  </div>
                </div>

                <div className="text-xs text-slate-400 mt-3 mb-1">Alarmtext (Melder) <span className="opacity-60">({(alarm||"").length}/160)</span></div>
                <textarea className="w-full rounded-2xl p-2 text-sm" rows="4" readOnly value={alarm}></textarea>
                <div className="mt-1"><button className="btn text-xs" onClick={()=>navigator.clipboard.writeText(alarm)}>Kopieren</button></div>

                <div className="border-t border-slate-700 my-3"></div>
                <div className="flex items-center justify-between">
                  <h3 className="font-medium">Mailer</h3>
                  <div className="flex gap-2">
                    <a className="btn text-xs bg-blue-600 text-white" href={mail.mailto}>In E-Mail öffnen</a>
                    <button className="btn text-xs" onClick={()=>navigator.clipboard.writeText(mail.body)}>Kopieren</button>
                  </div>
                </div>
                <textarea className="w-full rounded-2xl p-2 text-sm mt-1" rows="10" readOnly value={mail.body}></textarea>
              </section>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
