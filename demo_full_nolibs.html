<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notrufabfrage • AAO Demo (voll, ohne externe Icons)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> .btn{border-radius:1rem;padding:.5rem .75rem;box-shadow:0 1px 2px rgba(0,0,0,.1);} </style>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;

      // ===== AAO Daten (voll) =====
      const AAO_STICHWORTE_LANG = [
        // --- Rettungsdienst ---
        { Stichwort: "Krankentransport", Fahrzeuge_AAO: "NKTW oder RTW", Info: null },
        { Stichwort: "Notfall 1", Fahrzeuge_AAO: "RTW oder NKTW", Info: null },
        { Stichwort: "Notfall 2", Fahrzeuge_AAO: "RTW", Info: null },
        { Stichwort: "Reanimation", Fahrzeuge_AAO: "RTW oder NKTW", Info: "Reanimation" },
        { Stichwort: "Polytrauma", Fahrzeuge_AAO: "RTH & NEF & RTW", Info: "Schwerstverletzte" },

        // --- Brand ---
        { Stichwort: "B - 1", Fahrzeuge_AAO: "TLF oder (H)LF", Info: "Kleinbrand / PKW / Container / Kamin" },
        { Stichwort: "B - 2", Fahrzeuge_AAO: "ELW, 2x (H)LF, DLK, TLF & RTW", Info: "Wohnung / Dachstuhl / LKW" },
        { Stichwort: "B - 3", Fahrzeuge_AAO: "ELW, 3x (H)LF, DLK, 2x TLF & RTW", Info: "Industriebrand groß / Landwirtschaft" },
        { Stichwort: "B - 2Y", Fahrzeuge_AAO: "ELW, 2x (H)LF, DLK, TLF & NEF, 2x RTW", Info: "Brand mit 1 Person in Gefahr" },
        { Stichwort: "B - 3Y", Fahrzeuge_AAO: "ELW, 3x (H)LF, DLK, 2x TLF & NEF, 3x RTW", Info: "Brand mit 2 Personen in Gefahr" },
        { Stichwort: "B - 4Y", Fahrzeuge_AAO: "ELW, 3x (H)LF, DLK, 2x TLF & 2x NEF, 4x RTW", Info: "Brand mit 3+ Personen in Gefahr" },

        // --- TH ---
        { Stichwort: "TH - 1", Fahrzeuge_AAO: "HLF", Info: "Technische Hilfe klein" },
        { Stichwort: "TH - 2", Fahrzeuge_AAO: "HLF, RW", Info: "Technische Hilfe mittel" },
        { Stichwort: "TH - 3", Fahrzeuge_AAO: "ELW, 2x HLF, RW, TLF", Info: "Technische Hilfe groß" },
        { Stichwort: "TH - VU", Fahrzeuge_AAO: "HLF, RW, RTW", Info: "Verkehrsunfall" },
        { Stichwort: "TH - P-klemmt", Fahrzeuge_AAO: "ELW, HLF, RW, TLF & NEF, 2x RTW", Info: "VU / Person eingeklemmt" },
        { Stichwort: "TH - Wasser", Fahrzeuge_AAO: "HLF, Boot, GW-W", Info: "Wassernotlage" },
        { Stichwort: "TH - Höhen/Tiefen", Fahrzeuge_AAO: "HLF, Rüstwagen, Höhenretter", Info: "Rettung aus Höhen oder Tiefen" },
        { Stichwort: "TH - Gas 1", Fahrzeuge_AAO: "HLF", Info: "Gasgeruch" },
        { Stichwort: "TH - Gas 2", Fahrzeuge_AAO: "HLF, GW-G oder AB-G", Info: "Gasleitung beschädigt" },

        // --- MANV/Sonderlagen ---
        { Stichwort: "MANV-1", Fahrzeuge_AAO: "3x RTW, 2x NEF, 1x NKTW, LF KatS, LNA, San-Zug", Info: "5-9 Verletzte" },
        { Stichwort: "MANV-2", Fahrzeuge_AAO: "+ ORGL, ELRD, Betreuungszug", Info: "10-19 Verletzte" },
        { Stichwort: "MANV-3", Fahrzeuge_AAO: "+ ÄLRD, Versorgungszug", Info: "20-29 Verletzte" },
        { Stichwort: "RDAZ-1", Fahrzeuge_AAO: "2x RTW oder NKTW & 1x NEF", Info: "RD-Ausnahmezustand 1" },
        { Stichwort: "AL/TL", Fahrzeuge_AAO: "2x RTW, 1x NEF, LF KatS, LNA, ORGL, San-, Betreuungs-, Führungszug", Info: "Amok-/Terror-Lage" },
      ];

      function pickAAO(a) {
        const byKey = (k) => AAO_STICHWORTE_LANG.find((e) => e.Stichwort.toLowerCase() === k.toLowerCase()) || null;
        if (a.category === "Rettungsdienst") {
          if ((a.unconscious === "ja" && a.breathing === "nein") || /reani|cpr|herzstillstand/i.test(a.details)) return byKey("Reanimation");
          if (/polytrauma|mehrfachverletz|hochrasanz|sturz\s*>\s*3m/i.test(a.details)) return byKey("Polytrauma");
          if (a.unconscious === "ja" || a.breathing === "nein") return byKey("Notfall 2");
          return byKey("Notfall 1");
        }
        if (a.category === "Brand") {
          const p = typeof a.personsInDanger === "number" ? a.personsInDanger : 0;
          if (p >= 3) return byKey("B - 4Y");
          if (p === 2) return byKey("B - 3Y");
          if (p === 1) return byKey("B - 2Y");
          if (a.fireSize === "gross") return byKey("B - 3");
          if (a.fireSize === "mittel") return byKey("B - 2");
          return byKey("B - 1");
        }
        if (a.category === "Technische Hilfe") return byKey(a.thType);
        if (a.category === "MANV/Sonderlage") {
          const v = typeof a.personsInDanger === "number" ? a.personsInDanger : 0;
          if (/(amok|terror|schusswaffe|explosion)/i.test(a.details)) return byKey("AL/TL");
          if (v >= 20) return byKey("MANV-3");
          if (v >= 10) return byKey("MANV-2");
          if (v >= 5) return byKey("MANV-1");
          return byKey("RDAZ-1");
        }
        return null;
      }

      function buildMail(a, entry) {
        const subject = entry ? `${entry.Stichwort}` : "Voranfrage";
        const lines = [
          `Stichwort: ${entry ? entry.Stichwort : "(offen)"}`,
          `AAO Fahrzeuge: ${entry ? (entry.Fahrzeuge_AAO || "(offen)") : "(offen)"}`,
          `Info: ${entry && entry.Info ? entry.Info : "(keine)"}`,
          `—`,
          `Melder: ${a.callerName || "(unbekannt)"}`,
          `Rückruf: ${a.callbackNumber || "(unbekannt)"}`,
          `Adresse/PLZ: ${a.location || "(unbekannt)"}`,
          `Details: ${a.details || "(keine)"}`,
          `Kategorie: ${a.category || "(unbekannt)"}`,
          `Personen in Gefahr/Verletzt: ${a.personsInDanger === "" ? "(unbekannt)" : a.personsInDanger}`,
          `Bewusst/Atmung (nur RD): ${a.unconscious}/${a.breathing}`,
          `Brandgröße (nur Brand): ${a.fireSize || "(k.A.)"}`,
          `TH-Typ (nur TH): ${a.thType || "(k.A.)"}`,
        ];
        const body = lines.join("\n");
        const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        return { subject, body, mailto };
      }

      function buildAlarmText(a, entry, maxLen = 160) {
        const parts = [];
        const SW = (entry && entry.Stichwort) || "(Stichwort)";
        parts.push(SW);

        if (a.location) parts.push(a.location);

        const p = typeof a.personsInDanger === "number" ? a.personsInDanger : null;
        if (p !== null && p > 0) parts.push(`P:${p}`);

        if (a.category === "Brand" && a.fireSize) parts.push(`B:${a.fireSize}`);
        if (a.category === "Technische Hilfe" && a.thType) parts.push(`TH:${a.thType}`);
        if (a.category === "Rettungsdienst") {
          if (a.unconscious !== "unbekannt") parts.push(`Bew:${a.unconscious}`);
          if (a.breathing !== "unbekannt") parts.push(`Atm:${a.breathing}`);
        }

        const hint = ((entry && entry.Info) || "").trim();
        const det = (a.details || "").trim();
        const hintShort = (hint || det).replace(/\s+/g, " ").slice(0, 60);
        if (hintShort) parts.push(hintShort);

        if (a.callbackNumber) parts.push(`RK:${a.callbackNumber}`);
        if (a.callerName) parts.push(`M:${a.callerName}`);

        let text = parts.filter(Boolean).join(" | ").replace(/\s+/g, " ").trim();

        if (text.length > maxLen) {
          const idx = parts.findIndex((p) => p === hintShort);
          if (idx >= 0) {
            const over = text.length - maxLen;
            const keep = Math.max(20, 60 - over);
            parts[idx] = hintShort.slice(0, keep) + (hintShort.length > keep ? "…" : "");
            text = parts.join(" | ");
          }
        }
        if (text.length > maxLen && hintShort) {
          const idx = parts.findIndex((p) => p.startsWith(hintShort.slice(0, Math.min(5, hintShort.length))));
          if (idx >= 0) {
            parts.splice(idx, 1);
            text = parts.join(" | ");
          }
        }
        if (text.length > maxLen) text = text.slice(0, maxLen - 1) + "…";

        return text;
      }

      function LabeledInput({ label, value, onChange }) {
        return (
          <label className="block mb-3">
            <span className="block text-sm font-medium mb-1">{label}</span>
            <input className="w-full border rounded-xl p-2" value={value} onChange={(e) => onChange(e.target.value)} />
          </label>
        );
      }

      function NumberInput({ label, value, onChange }) {
        return (
          <label className="block mb-3">
            <span className="block text-sm font-medium mb-1">{label}</span>
            <input type="number" min={0} className="w-full border rounded-xl p-2" value={value}
              onChange={(e) => { const v = e.target.value; onChange(v === "" ? "" : Number(v)); }}/>
          </label>
        );
      }

      function LabeledTextArea({ label, value, onChange, rows = 4 }) {
        return (
          <label className="block mb-3">
            <span className="block text-sm font-medium mb-1">{label}</span>
            <textarea className="w-full border rounded-xl p-2" rows={rows} value={value} onChange={(e) => onChange(e.target.value)} />
          </label>
        );
      }

      function Select({ label, value, options, onChange }) {
        return (
          <label className="block mb-3">
            <span className="block text-sm font-medium mb-1">{label}</span>
            <select className="w-full border rounded-xl p-2 bg-white" value={value} onChange={(e) => onChange(e.target.value)}>
              {options.map((o) => (
                <option key={o} value={o}>{o || "— auswählen —"}</option>
              ))}
            </select>
          </label>
        );
      }

      function Row({ label, value, multiline = false }) {
        return (
          <div>
            <div className="text-xs text-slate-500">{label}</div>
            {multiline ? <div className="text-sm whitespace-pre-line">{value}</div> : <div className="text-sm">{value}</div>}
          </div>
        );
      }

      function App() {
        const [answers, setAnswers] = useState({
          category: "",
          personsInDanger: "",
          unconscious: "unbekannt",
          breathing: "unbekannt",
          gasSmell: "nein",
          thType: "",
          fireSize: "",
          details: "",
          callerName: "",
          callbackNumber: "",
          location: "",
        });
        const [copied, setCopied] = useState(false);
        const [copiedAlarm, setCopiedAlarm] = useState(false);

        const entry = useMemo(() => pickAAO(answers), [answers]);
        const mail = useMemo(() => buildMail(answers, entry), [answers, entry]);
        const alarm = useMemo(() => buildAlarmText(answers, entry), [answers, entry]);

        function setField(k, v) { setAnswers((s) => ({ ...s, [k]: v })); }

        return (
          <div className="min-h-screen bg-slate-50 p-6">
            <div className="mx-auto max-w-5xl">
              <h1 className="text-2xl font-bold tracking-tight">Notrufabfrage • Kamernstedter AAO (auto‑Stichwort)</h1>

              <div className="grid md:grid-cols-3 gap-4 mt-6">
                {/* Eingabe */}
                <section className="md:col-span-2 bg-white rounded-2xl shadow p-4">
                  <h2 className="font-semibold mb-3">Einsatzdaten</h2>
                  <LabeledInput label="Melder-Name" value={answers.callerName} onChange={(v) => setField("callerName", v)} />
                  <LabeledInput label="Rückrufnummer" value={answers.callbackNumber} onChange={(v) => setField("callbackNumber", v)} />
                  <LabeledInput label="Adresse/PLZ" value={answers.location} onChange={(v) => setField("location", v)} />

                  <Select label="Kategorie" value={answers.category} onChange={(v) => setField("category", v)} options={["", "Rettungsdienst", "Brand", "Technische Hilfe", "MANV/Sonderlage"]} />

                  {answers.category === "Brand" && (
                    <div className="grid md:grid-cols-2 gap-2">
                      <NumberInput label="Personen in Gefahr" value={answers.personsInDanger} onChange={(v) => setField("personsInDanger", v)} />
                      <Select label="Brandgröße" value={answers.fireSize} onChange={(v) => setField("fireSize", v)} options={["", "klein", "mittel", "gross"]} />
                    </div>
                  )}

                  {answers.category === "Technische Hilfe" && (
                    <div className="grid md:grid-cols-2 gap-2">
                      <Select label="TH‑Art" value={answers.thType} onChange={(v) => setField("thType", v)} options={["", ...AAO_STICHWORTE_LANG.filter((e) => e.Stichwort.startsWith("TH")).map((e) => e.Stichwort)]} />
                    </div>
                  )}

                  {answers.category === "Rettungsdienst" && (
                    <div className="grid md:grid-cols-2 gap-2">
                      <Select label="Bewusstlos?" value={answers.unconscious} onChange={(v) => setField("unconscious", v)} options={["unbekannt", "ja", "nein"]} />
                      <Select label="Atmung vorhanden?" value={answers.breathing} onChange={(v) => setField("breathing", v)} options={["unbekannt", "ja", "nein"]} />
                    </div>
                  )}

                  {answers.category === "MANV/Sonderlage" && (
                    <div className="grid md:grid-cols-2 gap-2">
                      <NumberInput label="Verletzte/Betroffene" value={answers.personsInDanger} onChange={(v) => setField("personsInDanger", v)} />
                      <LabeledInput label="Schlüsselwörter (z. B. Amok/Terror)" value={answers.details} onChange={(v) => setField("details", v)} />
                    </div>
                  )}

                  <LabeledTextArea label="Zusatzinfos (frei)" rows={3} value={answers.details} onChange={(v) => setField("details", v)} />
                </section>

                {/* Ergebnis */}
                <section className="md:col-span-1 bg-white rounded-2xl shadow p-4">
                  <h2 className="font-semibold mb-3">Ergebnis</h2>
                  <div className="space-y-2 text-sm">
                    <Row label="Stichwort" value={(entry && entry.Stichwort) || "(nicht bestimmt)"} />
                    <Row label="Fahrzeuge" value={(entry && entry.Fahrzeuge_AAO) || "(offen)"} />
                    <Row label="Info" value={(entry && entry.Info) || "(keine)"} multiline />
                  </div>

                  {/* Alarmtext */}
                  <div className="border-t my-3" />
                  <h3 className="font-medium mb-1">
                    Alarmtext (Melder) <span className="text-xs text-slate-500">({(alarm && alarm.length) || 0}/160)</span>
                  </h3>
                  <textarea className="w-full border rounded-xl p-2 text-sm" rows={4} readOnly value={alarm} />
                  <div className="flex items-center gap-2 mt-2">
                    <button
                      onClick={async () => {
                        try { await navigator.clipboard.writeText(alarm); setCopiedAlarm(true); setTimeout(() => setCopiedAlarm(false), 1400);} catch {}
                      }}
                      className="btn bg-slate-800 text-white text-sm"
                    >
                      📋 {copiedAlarm ? "Kopiert" : "Text kopieren"}
                    </button>
                  </div>

                  {/* Mailer */}
                  <div className="border-t my-3" />
                  <h3 className="font-medium mb-1">Mailer</h3>
                  <textarea className="w-full border rounded-xl p-2 text-sm" rows={10} readOnly value={mail.body} />
                  <div className="flex items-center gap-2 mt-2 flex-wrap">
                    <a href={mail.mailto} className="btn bg-blue-600 text-white text-sm">✉️ In E‑Mail öffnen</a>
                    <button
                      onClick={async () => {
                        try { await navigator.clipboard.writeText(mail.body); setCopied(true); setTimeout(() => setCopied(false), 1400);} catch {}
                      }}
                      className="btn bg-slate-800 text-white text-sm"
                    >
                      📋 {copied ? "Kopiert" : "Text kopieren"}
                    </button>
                  </div>
                </section>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
